# adRotation.js - Weighted Partner Selection

```javascript
/**
 * MaxClaim Weighted Ad Rotation v2.0
 * Ensures "Name Your Price" bidding works fairly
 * Higher bidders get proportionally more visibility
 */

/**
 * Select partners using weighted probability
 * @param {Array} partners - Array of partner objects with 'weight' or 'bidAmount'
 * @param {number} count - Number of partners to return (default 3)
 * @returns {Array} Selected partners
 */
export function getWeightedPartners(partners, count = 3) {
  if (!partners || partners.length === 0) {
    return [];
  }

  if (partners.length <= count) {
    return partners;
  }

  const selected = [];
  const pool = [...partners]; // Clone to avoid mutation

  while (selected.length < count && pool.length > 0) {
    // 1. Calculate total weight of remaining partners
    const totalWeight = pool.reduce((sum, p) => {
      // Use explicit weight or calculate from bidAmount
      const weight = p.weight || (p.bidAmount ? p.bidAmount / 15 : 1);
      return sum + weight;
    }, 0);

    // 2. Pick a random threshold
    let random = Math.random() * totalWeight;

    // 3. Find the partner that crosses the threshold
    for (let i = 0; i < pool.length; i++) {
      const weight = pool[i].weight || (pool[i].bidAmount ? pool[i].bidAmount / 15 : 1);
      random -= weight;

      if (random <= 0) {
        selected.push(pool[i]);
        pool.splice(i, 1); // Remove to prevent duplicates
        break;
      }
    }
  }

  return selected;
}

/**
 * Calculate visibility score for a partner
 * Shows how competitive their bid is (0-100%)
 * @param {number} bidAmount - Partner's current bid
 * @param {number} mvb - Minimum Viable Bid (default $15)
 * @param {number} premiumBid - Premium tier threshold (default $75)
 * @returns {Object} Visibility metrics
 */
export function calculateVisibilityScore(bidAmount, mvb = 15, premiumBid = 75) {
  if (bidAmount < mvb) {
    return {
      score: 0,
      tier: 'BELOW_MINIMUM',
      message: `Bid must be at least $${mvb} to be visible`
    };
  }

  const weight = bidAmount / mvb;
  const scorePercentage = Math.min((bidAmount / premiumBid) * 100, 100);

  let tier = 'BASIC';
  if (bidAmount >= premiumBid) {
    tier = 'PREMIUM';
  } else if (bidAmount >= (mvb + premiumBid) / 2) {
    tier = 'COMPETITIVE';
  }

  return {
    score: Math.round(scorePercentage),
    weight,
    tier,
    message: getTierMessage(tier, bidAmount, premiumBid)
  };
}

/**
 * Get tier-specific messaging
 */
function getTierMessage(tier, bidAmount, premiumBid) {
  switch (tier) {
    case 'PREMIUM':
      return 'Top-tier visibility. You are guaranteed in top 3 placements.';

    case 'COMPETITIVE':
      return `Strong visibility. Increase by $${(premiumBid - bidAmount).toFixed(0)} to reach premium tier.`;

    case 'BASIC':
      return `Basic visibility. Consider increasing your bid to appear more frequently.`;

    default:
      return 'Bid is below minimum threshold.';
  }
}

/**
 * Apply geographic multiplier to bid weight
 * High-demand areas get premium pricing
 * @param {number} baseWeight 
 * @param {string} zipCode 
 * @returns {number} Adjusted weight
 */
export function applyGeoMultiplier(baseWeight, zipCode) {
  const HIGH_DEMAND_METROS = {
    'Austin': ['78701', '78702', '78703', '78704', '78705'], // +20%
    'Houston': ['77002', '77003', '77004'], // +20%
    'Dallas': ['75201', '75202', '75203'] // +20%
  };

  for (const [metro, codes] of Object.entries(HIGH_DEMAND_METROS)) {
    if (codes.includes(zipCode)) {
      return baseWeight * 1.2; // 20% boost
    }
  }

  return baseWeight; // No adjustment
}

/**
 * Simulate ad rotation to test fairness
 * Useful for debugging bid effectiveness
 * @param {Array} partners 
 * @param {number} iterations 
 * @returns {Object} Statistics
 */
export function simulateRotation(partners, iterations = 1000) {
  const stats = {};

  partners.forEach(p => {
    stats[p.id] = { count: 0, percentage: 0 };
  });

  for (let i = 0; i < iterations; i++) {
    const selected = getWeightedPartners(partners, 3);
    selected.forEach(p => {
      stats[p.id].count++;
    });
  }

  // Calculate percentages
  Object.keys(stats).forEach(id => {
    stats[id].percentage = ((stats[id].count / iterations) * 100).toFixed(2);
  });

  return stats;
}
```

## Usage Example

```javascript
import { getWeightedPartners, calculateVisibilityScore } from './adRotation.js';

const partners = [
  { id: 'A', name: 'Premium Roofing', bidAmount: 75, category: 'Roofing' },
  { id: 'B', name: 'Budget Roofers', bidAmount: 15, category: 'Roofing' },
  { id: 'C', name: 'Mid-Tier Roofing', bidAmount: 35, category: 'Roofing' }
];

// Get top 3 partners (weighted by bid)
const selected = getWeightedPartners(partners, 3);
console.log(selected);
// Premium Roofing appears ~5x more often than Budget Roofers

// Check visibility score
const visibility = calculateVisibilityScore(35);
console.log(visibility);
// { score: 47, weight: 2.33, tier: 'COMPETITIVE', message: '...' }
```

## Key Features

- **Fair Weighted Selection**: Higher bids = more visibility, but not exclusive
- **Anti-Duplicate Logic**: Same partner never shown twice in same result
- **Visibility Scoring**: Shows partners how competitive they are (0-100%)
- **Geographic Premiums**: +20% weight for high-demand metros
- **Simulation Tool**: Test rotation fairness before deploying
